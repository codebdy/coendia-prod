---
import Layout from "@/layouts/Layout.astro";
import { rx } from "theme";
import { rxPage } from "@rxdrag/website-lib-core";
import { Meta, Tabs, TabsHeader, TabsTab, Flip, TabsBody, TabsPanel, RichTextView } from "@rxdrag/website-lib";
import { Medias, Share, AttachmentIcon } from "@rxdrag/website-lib-core";
import Header from "@/components/Header.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import EnquiryTrigger from "@/components/EnquiryTrigger.astro";
import Features from "@/components/Features.astro";
import ProductCard from "@/components/ProductCard.astro";
import CtaBlock from "@/components/CtaBlock.astro";
import Footer from "@/components/Footer.astro";
import Globals from "@/components/Globals.astro";
// 生成静态路径
export async function getStaticPaths() {
  // 获取所有产品的静态路径
  return await rx.getProductPaths();
}
//export const prerender = false;
// 在组件加载时获取产品详情
const { slug } = Astro.params;
if (!slug) {
  return Astro.redirect("/404");
}
const product = await rx.getProductBySlug(slug, {
  width: 800,
  height: 800,
});
// 如果产品不存在，返回 404
if (!product) {
  return Astro.redirect("/404");
}
const qualities = (product.extends as any)?.quality?.split("\n") as
  | string[]
  | undefined;
// 生成面包屑
const breadcrumbs = rxPage.productBreadcrumbs(product, "首页", "产品");---

<Layout>
  <Meta title={product?.title} content={product?.meta} slot="meta" />
  <Header />
  <Breadcrumb separator="/" items={breadcrumbs} title={product?.title} />

  <main class="container">
    <section class="m-h-20 w-full mt-20">
      <div
        id="grid-1"
        class="container lg:grid lg:grid-cols-7 lg:grid-rows-1 lg:gap-x-8 lg:gap-y-10 xl:gap-x-16"
      >
        <div class="lg:col-span-4">
          <Medias value={product?.medias} client:load />
        </div>
        <div
          class="w-full mx-auto mt-14 max-w-2xl sm:mt-16 lg:col-span-3 lg:row-span-2 lg:mt-0 lg:max-w-none"
        >
          <div
            class="-mt-5 -ml-5 lg:scrolled top-24 p-5 bg-white lg:scrolled:shadow-lg lg:sticky rounded-md transition-all"
          >
            <h1 class="text-2xl font-bold tracking-tight text-gray-900">
              {product.title}
            </h1>
            <p class="mt-2 text-gray-500">
              {product.description}
            </p>
            <div class="mt-8 max-w-xs">
              <EnquiryTrigger
                class="flex w-full items-center justify-center rounded-md border border-transparent btn-primary px-8 py-3 font-bold text-white hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 focus:ring-offset-gray-50"
                callToAction="产品详情">获取报价</EnquiryTrigger
              >
            </div>
          </div>
          {
            !!product?.features?.length && (
              <div class="mt-5 border-t border-gray-200 pt-10">
                <h3 class="text-sm font-medium text-gray-900">特性</h3>
                <div class="prose prose-sm mt-4 text-gray-500">
                  <Features
                    class="flex flex-col gap-2 text-sm"
                    value={product?.features}
                  />
                </div>
              </div>
            )
          }
          <div class="mt-10 border-t border-gray-200 pt-10">
            <h3 class="text-sm font-medium text-gray-900">
              质量保证
            </h3>
            {
              qualities?.map((quality) => (
                <p class="mt-4 text-sm text-gray-500">{quality}</p>
              ))
            }
          </div>
          <div class="mt-10 border-t border-gray-200 pt-10">
            <div class="text-sm font-medium text-gray-900 mb-4">分享</div>
          </div>
          <Share client:load />
        </div>
        <div
          class="mx-auto mt-16 w-full max-w-2xl lg:col-span-4 lg:mt-0 lg:max-w-none min-h-[300px]"
        >
          <Tabs class="flex flex-col">
            <TabsHeader
              class="tabs-header"
              flipTransition={{
                duration: 300,
                ease: "easeInOut",
              }}
            >
              <TabsTab class="tabs-tab selected">
                <span>更多信息</span>
                <Flip flipKey="tab-indicator" class="tab-indicator" />
              </TabsTab>
              {
                !!product?.attachments?.length && (
                  <TabsTab class="tabs-tab">
                    <span>下载</span>
                    <Flip flipKey="tab-indicator" class="tab-indicator" />
                  </TabsTab>
                )
              }
            </TabsHeader>
            <TabsBody>
              <TabsPanel class="tabs-panel" whileSelection="fade-up">
                <RichTextView
                  class="max-w-3xl prose mt-1"
                  value={product?.content}
                />
              </TabsPanel>
              {
                !!product?.attachments?.length && (
                  <TabsPanel class="tabs-panel" whileSelection="fade-up">
                    <h2 class="text-2xl text-black font-semibold">
                      可下载文档
                    </h2>
                    <ul class="mt-10 text-sm flex flex-col">
                      {product?.attachments?.map((attachment) => (
                        <li class="flex items-center justify-between py-4 border-b border-gray-200">
                          <a
                            class="hover:text-primary-600 flex items-center gap-1"
                            href={attachment?.url}
                            target="_blank"
                          >
                            <AttachmentIcon
                              className="h-6 w-6"
                              extName={attachment?.extName}
                            />
                            <span>{attachment?.name}</span>
                          </a>
                          <a
                            class="text-sky-600 hover:text-sky-400"
                            href={attachment?.url}
                            target="_blank"
                          >
                            <span>下载</span>
                          </a>
                        </li>
                      ))}
                    </ul>
                    <p class="mt-6 text-sm text-gray-500 italic flex items-center gap-2">
                      <span class="h-5 w-5">
                        <svg
                          aria-hidden="true"
                          class="h-5 w-5"
                          fill="currentColor"
                          focusable="false"
                          viewBox="0 0 24 24"
                        >
                          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
                        </svg>
                      </span>
                      <span>如需最新资料，请联系我们</span>
                    </p>
                  </TabsPanel>
                )
              }
            </TabsBody>
          </Tabs>
        </div>
      </div>
    </section>
    {
      !!product?.related?.length && (
        <section class="m-h-20 w-full mt-8">
          <div class="container mx-auto mt-24 w-full lg:col-span-4 border-t py-6 pt-12">
            <div class="flex justify-center">
              <h2 class="block-title">相关解决方案</h2>
            </div>
            <div class="grid grid-cols-4 mt-10 gap-4">
              {product?.related?.map((related) => (
                <ProductCard product={related} ctaTitle="获取报价" />
              ))}
            </div>
          </div>
        </section>
      )
    }
  </main>
  <CtaBlock />
  <Footer />
  <Globals />
</Layout>

<style>
  .tab-indicator {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 2px;
    background-color: #0070f3;
    border-radius: 1px;
    transition: opacity 0.3s ease;
  }

  .tabs-tab {
    position: relative;
    padding-bottom: 4px;
  }
</style>