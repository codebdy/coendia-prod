---
import Layout from "@/layouts/Layout.astro";
import { rx } from "theme";
import { rxPage } from "@rxdrag/website-lib-core";
import dayjs from "dayjs";
import { Meta, Link, RichTextView } from "@rxdrag/website-lib";
import { RichTextOutline, Share } from "@rxdrag/website-lib-core";
import Header from "@/components/Header.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import CtaBlock from "@/components/CtaBlock.astro";
import Footer from "@/components/Footer.astro";
import Globals from "@/components/Globals.astro";
// 生成静态路径
export async function getStaticPaths() {
  // 获取所有文章的静态路径
  return await rx.getPostPaths();
}
// 启用服务器端渲染，处理所有路径
//export const prerender = false;
// 在组件加载时获取文章详情
const { slug } = Astro.params;
if (!slug) {
  return Astro.redirect("/404");
}
const post = await rx.getPostBySlug(slug, {
  width: 1200,
  height: 600,
});
// 如果文章不存在，返回 404
if (!post) {
  return Astro.redirect("/404");
}
// 生成面包屑
const breadcrumbs = rxPage.postBreadcrumbs(post, "Главная", "Блог");---

<Layout>
  <Meta title={post?.title} content={post?.meta} slot="meta" />
  <Header />
  <Breadcrumb items={breadcrumbs} />

  <main class="container">
    <section class="m-h-20 w-full mt-4">
      <div class="flex justify-start gap-24">
        <div class="w-96 mt-12 relative hidden lg:block">
          <div
            class="sticky top-24 overflow-auto flex flex-col gap-2 h-[calc(100vh-120px)]"
          >
            <div>
              <h2 class="text-2xl text-black ml-2">Содержание</h2>
            </div>
            <RichTextOutline
              itemClassName="border-b p-3 rounded-md actived:bg-primary-200 actived:font-semibold actived:text-primary-900 hover:bg-primary-50"
              value={post.content}
              client:load
            />
            <div><Share className="pl-2 mt-2" client:load /></div>
          </div>
        </div>
        <div class="flex-1 flex flex-col gap-8 mt-8 max-w-3xl">
          <h1 class="text-4xl font-bold leading-normal">
            {post.title}
          </h1>
          <hr />
          <div class="relative flex items-center justify-between">
            {
              post?.author && (
                <div class="relative flex items-center gap-x-4">
                  <img
                    class="h-20 w-20 rounded-full bg-gray-50"
                    src={post?.author?.avatar?.thumbnail}
                    alt={post?.author?.name || "Изображение автора"}
                  />
                  <div class="flex items-center gap-2">
                    <Link
                      type="user"
                      to={post?.author?.id || ""}
                      class="text-gray-600 font-semibold hover:text-sky-600"
                    >
                      {post?.author?.name}
                    </Link>
                  </div>
                </div>
              )
            }
            <p class="text-gray-600 text-sm">
              {dayjs(post?.createdAt)?.format("MMMM D, YYYY")}
            </p>
          </div>
          {
            post.content && (
              <RichTextView class="prose max-w-3xl" value={post.content} />
            )
          }
        </div>
      </div>
    </section>
  </main>

  <CtaBlock />
  <Footer />
  <Globals />
</Layout>